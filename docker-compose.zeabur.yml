version: '3.8'

services:
  # MariaDB 資料庫服務
  mariadb:
    image: mariadb:11.3.2
    container_name: rosca-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_general_ci
      TZ: Asia/Taipei
    volumes:
      - db-data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --init-connect='SET NAMES utf8mb4'
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      timeout: 20s
      retries: 10
      interval: 30s
      start_period: 80s

  # .NET Core 後端微服務
  backend-service:
    build:
      context: ./backendAPI/DotNetBackEndCleanArchitecture
      dockerfile: Presentation/DotNetBackEndService/Dockerfile
    container_name: rosca-backend-service
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_URLS: http://+:5001
      ConnectionStrings__BackEndDatabase: "Server=mariadb;Port=3306;User Id=${DB_USER};Password=${DB_PASSWORD};Database=${DB_NAME};CharSet=utf8mb4;AllowUserVariables=True;UseAffectedRows=False;"
      TZ: Asia/Taipei
      JWT__SecretKey: ${JWT_SECRET_KEY}
      JWT__Issuer: ${JWT_ISSUER}
      JWT__Audience: ${JWT_AUDIENCE}
      JWT__ExpiryMinutes: ${JWT_EXPIRY_MINUTES}
      Serilog__MinimumLevel__Default: ${LOG_LEVEL}
    volumes:
      - uploads:/app/uploads
      - backend-kycimages:/app/KycImages
      - backend-depositimages:/app/DepositImages
      - backend-withdrawimages:/app/WithdrawImages
      - backend-annimages:/app/AnnImagessss
    depends_on:
      mariadb:
        condition: service_healthy

  # .NET Core API Gateway
  backend:
    build:
      context: ./backendAPI/DotNetBackEndCleanArchitecture
      dockerfile: Dockerfile
    container_name: rosca-backend
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_URLS: http://+:5000
      ConnectionStrings__BackEndDatabase: "Server=mariadb;Port=3306;User Id=${DB_USER};Password=${DB_PASSWORD};Database=${DB_NAME};CharSet=utf8mb4;AllowUserVariables=True;UseAffectedRows=False;"
      APIUrl: "http://backend-service:5001/"
      TZ: Asia/Taipei
      JWT__SecretKey: ${JWT_SECRET_KEY}
      JWT__Issuer: ${JWT_ISSUER}
      JWT__Audience: ${JWT_AUDIENCE}
      JWT__ExpiryMinutes: ${JWT_EXPIRY_MINUTES}
      CORS__AllowedOrigins: ${CORS_ALLOWED_ORIGINS}
      FileUpload__MaxFileSize: ${FILE_UPLOAD_MAX_SIZE}
      FileUpload__AllowedExtensions: ${FILE_UPLOAD_EXTENSIONS}
      Hangfire__DashboardEnabled: ${HANGFIRE_DASHBOARD_ENABLED}
      Serilog__MinimumLevel__Default: ${LOG_LEVEL}
    volumes:
      - uploads:/app/uploads
      - backend-kycimages:/app/KycImages
      - backend-depositimages:/app/DepositImages
      - backend-withdrawimages:/app/WithdrawImages
      - backend-annimages:/app/AnnImagessss
    depends_on:
      - mariadb
      - backend-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/HomePicture/GetAnnImages"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 60s

  # 前台使用者系統 (Vue.js + Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rosca-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      timeout: 10s
      retries: 3
      interval: 30s

  # 後台管理系統 (Angular + Nginx)
  admin:
    build:
      context: ./backend/FontEnd
      dockerfile: Dockerfile
    container_name: rosca-admin
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      timeout: 10s
      retries: 3
      interval: 30s

volumes:
  db-data:
    driver: local
  uploads:
    driver: local
  backend-kycimages:
    driver: local
  backend-depositimages:
    driver: local
  backend-withdrawimages:
    driver: local
  backend-annimages:
    driver: local